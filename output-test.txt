#INFO: **** input file is /Users/jaydenl/Dev/ASDRP/QCHEM/PySCF-UI/test.py ****
import streamlit as st
import streamlit.components.v1 as components
from pyscf import gto, scf
from streamlit.runtime.scriptrunner import add_script_run_ctx
import threading
import time
from stmol import *
import py3Dmol
from rdkit import Chem
from rdkit.Chem import rdDetermineBonds
from rdkit.Chem.rdmolfiles import MolFromXYZFile
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from collections import defaultdict
import altair as alt

if 'queue' not in st.session_state:
    st.session_state['queue'] = []
if 'results' not in st.session_state:
    st.session_state['results'] = []
if 'computing' not in st.session_state:
    st.session_state['computing'] = False


def compute_pyscf(atom, basis_option, verbose_option):
    # print(atom)
    # print(basis_option)
    # print(verbose_option)
    mol = gto.Mole()
    mol.atom = atom
    mol.basis = basis_option
    mol.verbose = int(verbose_option[0])
    mol.output = 'output-test.txt'
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    outputFile = open("output-test.txt", "r")
    # Extract energy and time information
    time = None
    energy = None
    for line in outputFile.readlines():
        if line.startswith("    CPU time for SCF"):
            time = float(line.split(" ")[-2])

        elif line.startswith("converged SCF energy = "):
            energy = float(line.split(" ")[-1])
    return energy, time


def getMoleculeName(atom):
    d = {}
    for line in atom.split("\n"):
        try:
            name = line.split()[0]
            if name in d:
                d[name] += 1
            else:
                d[name] = 1
        except:
            pass
    name = ""
    for key in d:
        name += key + str(d[key])
    return name


# Streamlit layout
st.title("PySCF")

# Function to process the uploaded text file


def process_text_file(uploaded_file):
    if uploaded_file is not None:
        # Read the contents of the file
        text_contents = uploaded_file.getvalue().decode("utf-8")
        return text_contents
    else:
        return None




# Display file uploader for a single text file and processes it
uploaded_file = st.file_uploader("Upload a XYZ input", type=["txt"])
text_contents = process_text_file(uploaded_file)

# Create a Streamlit button which gives example
with st.expander("See Example Input"):
    st.write("C 0.0000000 0.0000000 0.0000000")
    st.write("H 0.6311940 0.6311940 0.6311940")
    st.write("H -0.6311940 -0.6311940 0.6311940")
    st.write("H -0.6311940 0.6311940 -0.6311940")
    st.write("H 0.6311940 -0.6311940 -0.631194")

# Fills xyz_input text area to the contents of the uploaded file
xyz_input = st.text_area(
    "XYZ Input", value=text_contents) if text_contents else st.text_area("XYZ Input")

def addToQueue(atom):
    st.session_state['queue'].append(atom)

if st.button('Add to Queue', use_container_width=True):
    if xyz_input:
        addToQueue(xyz_input)
    else:
        st.warning(
            "Please provide an XYZ input using the text box or inputting a text file.")


basis_option = st.selectbox("Basis", ["cc-pVTZ", "asdf"])
verbose_option = st.selectbox("Verbose", index=2, options=[
                              "3, energy only", "4, cycles and energy", "5, cycles energy and runtime", "9, max"])

col1, col2, col3, col4 = st.columns(4, gap="small")

# if col1.button("Add to Queue"):
#     if xyz_input:
#         addToQueue(xyz_input)
#     else:
#         st.warning(
#             "Please provide an XYZ input using the text box or inputting a text file.")

# Computes only if something is added to the queue; grayed out otherwise
compute_disabled = len(st.session_state['queue']) == 0
if st.button("Compute", disabled=compute_disabled, type="primary", use_container_width=True) or st.session_state['computing'] == True:
    if len(st.session_state['queue']) > 0:
        with st.spinner("Computing " + getMoleculeName(st.session_state['queue'][0]) + "..."):
            st.session_state['computing'] = True
            atom = st.session_state['queue'][0]
            st.session_state['queue'].pop(0)
            # st.write("Computing...")
            # progress_text = "Computing..."
            # my_bar = st.progress(0, text=progress_text)

            # for percent_complete in range(100):
            #     time.sleep(0.01)
            #     my_bar.progress(percent_complete + 1, text=progress_text)
            # time.sleep(1)
            # my_bar.empty()
            
            # Delete empty lines
            parsed = [line for line in atom.splitlines() if line.strip() != ""]
            xyz = "\n".join(parsed)
            mol = f"{len(parsed)}\nname\n{str(xyz)}"
            
            # output xyz into molecule.xyz file
            with open('molecule.xyz', 'w') as f:
                f.write(f"{len(parsed)}\n\n{str(xyz)}")
                
            raw_mol = MolFromXYZFile('molecule.xyz')
            rdkit_mol = Chem.Mol(raw_mol)
            rdDetermineBonds.DetermineBonds(rdkit_mol, charge=0)
                
            
            energy, time_val = compute_pyscf(
                atom, basis_option, verbose_option)
            molecule_name = getMoleculeName(atom)
            st.session_state['results'].append(
                (molecule_name, energy, time_val, mol, rdkit_mol))
            st.rerun()
    elif st.session_state['computing'] == True:
        st.session_state['computing'] = False
    else:
        st.warning("Please add an XYZ input to the queue.")

if 'queue' in st.session_state:
    st.subheader("Queue")
    for queue_item in st.session_state['queue']:
        st.write(getMoleculeName(queue_item))
        

tab1, tab2, tab3 = st.tabs(['Results', 'View Graphs', 'View Logs'])
        
with tab1:
    if 'results' in st.session_state:
        st.subheader("Results")
        for result_item in st.session_state['results']:
            with st.container():
                result_col_1, result_col_2 = st.columns([2,1])
                result_col_1.write(
                    f"{result_item[0]} | Energy: {result_item[1]} | Time: {result_item[2]} seconds")
                result_col_1.write(
                    f"\# of Atoms: {result_item[4].GetNumAtoms()} | \# of Bonds: {result_item[4].GetNumBonds()} | \# of Conformers:  {result_item[4].GetNumConformers()}")
                with result_col_2:
                    speck_plot(result_item[3], component_h=200, component_w=200, wbox_height="auto", wbox_width="auto")

with tab2:
    def count_atoms(m):
        atomic_count = defaultdict(lambda : 0)
        for atom in m.GetAtoms():
            atomic_count[atom.GetAtomicNum()] += 1
        return atomic_count
            
    if 'results' in st.session_state and len(st.session_state['results']) > 1:
        st.subheader("Comparative Graphs")
        
        atom_counts = [count_atoms(result_item[4]) for result_item in st.session_state['results']]
        
        # Prepare datasets
        num_atoms = [result_item[4].GetNumAtoms() for result_item in st.session_state['results']]
        num_bonds = [result_item[4].GetNumBonds() for result_item in st.session_state['results']]
        num_conformers = [result_item[4].GetNumConformers() for result_item in st.session_state['results']]
        # 6 and 1 are atomic code
        num_carbons = [atom_counts[i][6] for i in range(len(atom_counts))]
        num_hydrogens = [atom_counts[i][1] for i in range(len(atom_counts))]
        
        energies = [result_item[1] for result_item in st.session_state['results']]
        runtimes = [result_item[2] for result_item in st.session_state['results']]

        df_atoms = pd.DataFrame({'Atoms': num_atoms, 'Energy': energies, 'Runtime': runtimes})
        df_bonds = pd.DataFrame({'Bonds': num_bonds, 'Energy': energies, 'Runtime': runtimes})
        df_conformers = pd.DataFrame({'Conformers': num_conformers, 'Energy': energies, 'Runtime': runtimes})
        df_carbons = pd.DataFrame({'Carbons': num_carbons, 'Energy': energies, 'Runtime': runtimes})
        df_hydrogens = pd.DataFrame({'Hydrogens': num_hydrogens, 'Energy': energies, 'Runtime': runtimes})
        

        # Generate Graphs  
        for df, label in zip([df_atoms, df_bonds, df_carbons, df_hydrogens], ['Atoms', 'Bonds', 'Carbons', 'Hydrogens']):
            for target in ['Energy', 'Runtime']:
                st.markdown(f'### Number of {label} vs. {target}')

                # Linear Regression
                coeffs_linear = np.polyfit(df[label].values, df[target].values, 1)
                poly1d_fn_linear = np.poly1d(coeffs_linear)
                x = np.linspace(min(df[label]), max(df[label]), 100)
                
                # Quadratic Regression
                coeffs_quad = np.polyfit(df[label].values, df[target].values, 2)
                poly1d_fn_quad = np.poly1d(coeffs_quad)
                
                # Display Equations
                st.markdown(f"<span style='color: red;'>Best Fit Linear Equation ({target}): Y = {coeffs_linear[0]:.4f}x + {coeffs_linear[1]:.4f}</span>", unsafe_allow_html=True)
                st.markdown(f"<span style='color: green;'>Best Fit Quadratic Equation ({target}): Y = {coeffs_quad[0]:.4f}xÂ² + {coeffs_quad[1]:.4f}x + {coeffs_quad[2]:.4f}</span>", unsafe_allow_html=True)

                # Create a DataFrame for the regression lines
                df_line = pd.DataFrame({label: x, 'Linear': poly1d_fn_linear(x), 'Quadratic': poly1d_fn_quad(x)})

                # Plot
                scatter = alt.Chart(df).mark_circle(size=60).encode(
                    x=label,
                    y=target,
                    tooltip=[label, target]
                )

                line_linear = alt.Chart(df_line).mark_line(color='red').encode(
                    x=label,
                    y='Linear'
                )

                line_quad = alt.Chart(df_line).mark_line(color='green').encode(
                    x=label,
                    y='Quadratic'
                )

                # Display the plot
                st.altair_chart(scatter + line_linear + line_quad, use_container_width=True)
 
            # Display Equation
            # st.write(f"Best Fit Equation ({target}): Y = {coeffs[0]:.4f}x + {coeffs[1]:.4f}")

with tab3:
    with open('output-test.txt', 'r') as file:
        log_data = file.read()
        st.markdown(f'```\n{log_data}\n```')

        
# xyzview = py3Dmol.view(query='pdb:1A2C') 
# xyzview.setStyle({'cartoon':{'color':'spectrum'}})
# showmol(xyzview, height = 500,width=800)

# def draw_with_spheres(mol):
#     v = py3Dmol.view(width=300,height=300)
#     IPythonConsole.addMolToView(mol,v)
#     v.zoomTo()
#     v.setStyle({'sphere':{'radius':0.3},'stick':{'radius':0.2}});
#     v.show()


# Attempt at creating an async queue, need to find a way to detect browser closing to stop the queue

# def runQueue():
#     for i in range(1, 10):
#         time.sleep(1)
#         print("test", str(i))


# if 'queue-running' not in st.session_state:
#     st.session_state['queue-running'] = True
#     t = threading.Thread(target=runQueue)
#     add_script_run_ctx(t)
#     t.start()

# components.html("""<html>
# <script>
#     const origClose = window.close;
#     window.close = () => {
#         console.log("asdf");
#         // origClose();
#     }
#     document.addEventListener("beforeunload", () => {
#                 alert(1);
#                 console.log(a.a.a.a);
#     })
# </script>
# <div style="color: white" onclick="">
#                 hihihihi
# </div>
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='jaydens-macbook.lan', release='23.0.0', version='Darwin Kernel Version 23.0.0: Fri Sep 15 14:41:34 PDT 2023; root:xnu-10002.1.13~1/RELEASE_ARM64_T8103', machine='arm64', processor='arm')  Threads 1
Python 3.8.18 | packaged by conda-forge | (default, Oct 10 2023, 15:46:56) 
[Clang 16.0.6 ]
numpy 1.24.4  scipy 1.10.1
Date: Fri Nov 24 15:04:22 2023
PySCF version 2.4.0
PySCF path  /Users/jaydenl/anaconda3/envs/pyscfui/lib/python3.8/site-packages/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 5
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 11
[INPUT] num. electrons = 26
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 C      0.000000000000   0.000000000000   0.586388000000 AA    0.000000000000   0.000000000000   1.108112722731 Bohr   0.0
[INPUT]  2 C      0.000000000000   1.277266000000  -0.259869000000 AA    0.000000000000   2.413682928219  -0.491081238265 Bohr   0.0
[INPUT]  3 C      0.000000000000  -1.277266000000  -0.259869000000 AA    0.000000000000  -2.413682928219  -0.491081238265 Bohr   0.0
[INPUT]  4 H      0.877649000000   0.000000000000   1.247032000000 AA    1.658516243498   0.000000000000   2.356548948569 Bohr   0.0
[INPUT]  5 H     -0.877649000000   0.000000000000   1.247032000000 AA   -1.658516243498   0.000000000000   2.356548948569 Bohr   0.0
[INPUT]  6 H      0.000000000000   2.176007000000   0.367701000000 AA    0.000000000000   4.112057275136   0.694854185729 Bohr   0.0
[INPUT]  7 H      0.000000000000  -2.176007000000   0.367701000000 AA    0.000000000000  -4.112057275136   0.694854185729 Bohr   0.0
[INPUT]  8 H      0.884627000000   1.322417000000  -0.907341000000 AA    1.671702752396   2.499005952469  -1.714625991589 Bohr   0.0
[INPUT]  9 H     -0.884627000000   1.322417000000  -0.907341000000 AA   -1.671702752396   2.499005952469  -1.714625991589 Bohr   0.0
[INPUT] 10 H     -0.884627000000  -1.322417000000  -0.907341000000 AA   -1.671702752396  -2.499005952469  -1.714625991589 Bohr   0.0
[INPUT] 11 H      0.884627000000  -1.322417000000  -0.907341000000 AA    1.671702752396  -2.499005952469  -1.714625991589 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] C
[INPUT] 0    0    [8    /2   ]  8236              0.000531 -0.000113
                                1235              0.004108 -0.000878
                                280.8             0.021087 -0.00454
                                79.27             0.081853 -0.018133
                                25.59             0.234817 -0.05576
                                8.997             0.434401 -0.126895
                                3.319             0.346129 -0.170352
                                0.3643            -0.008983 0.598684
[INPUT] 0    0    [1    /1   ]  0.9059               1
[INPUT] 0    0    [1    /1   ]  0.1285               1
[INPUT] 1    0    [3    /1   ]  18.71             0.014031
                                4.133             0.086866
                                1.2               0.290216
[INPUT] 1    0    [1    /1   ]  0.3827               1
[INPUT] 1    0    [1    /1   ]  0.1209               1
[INPUT] 2    0    [1    /1   ]  1.097                1
[INPUT] 2    0    [1    /1   ]  0.318                1
[INPUT] 3    0    [1    /1   ]  0.761                1
[INPUT] H
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1

nuclear repulsion = 82.2541352596295
number of shells = 75
number of NR pGTOs = 254
number of NR cGTOs = 202
basis = cc-pVTZ
ecp = {}
CPU time:        79.22


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /var/folders/_x/xd2ms3z958s6pfllwphw48vm0000gn/T/tmpt4e7zflg
max_memory 4000 MB (current use 0 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
E1 = -318.7599846605191  E_coul = 118.01906776170844
init E= -118.486781639181
cond(S) = 8667.21932493932
    CPU time for initialize scf      9.38 sec, wall time      4.98 sec
  HOMO = -0.35635015575361  LUMO = 0.094209396520669
  mo_energy =
[-11.31864458 -11.31716997 -11.31200258  -1.49577915  -1.18138639
  -0.91811343  -0.59192188  -0.55122218  -0.47667071  -0.4474612
  -0.37238884  -0.37085662  -0.35635016   0.0942094    0.13741822
   0.14731599   0.15993362   0.17875522   0.20672668   0.21293243
   0.22626932   0.24998117   0.31374017   0.35508771   0.35937239
   0.37430101   0.39203711   0.40185728   0.45757205   0.48988158
   0.53581887   0.53763126   0.54381659   0.55173202   0.56848213
   0.57295196   0.58026082   0.60708316   0.60838055   0.6140933
   0.69057229   0.72583008   0.76987119   0.85444633   0.85710316
   0.87821124   0.92027276   0.94322926   1.01705237   1.04574852
   1.09389508   1.10996005   1.1355253    1.15784039   1.17692563
   1.20111853   1.22400131   1.25415567   1.26469154   1.28227238
   1.28723268   1.33509579   1.34054841   1.35124085   1.36378753
   1.40733949   1.41219248   1.44010934   1.47198577   1.47434868
   1.50809538   1.5411012    1.56771313   1.56968714   1.60315223
   1.64639911   1.68036979   1.6983274    1.73677958   1.74851637
   1.80647975   1.84927341   2.41636128   2.47393624   2.48060587
   2.53219712   2.55427969   2.59940748   2.66575047   2.68947886
   2.71243779   2.74021959   2.74616854   2.77558999   2.85592993
   2.86669754   2.8887066    2.94341395   3.00644803   3.02956828
   3.04875711   3.05203312   3.05691254   3.07778915   3.13591649
   3.15105161   3.16112641   3.25461723   3.25857856   3.28916818
   3.2894826    3.2942258    3.31458651   3.32952403   3.35468057
   3.39051233   3.39733598   3.41768581   3.43884548   3.50202356
   3.52079093   3.57279501   3.59926126   3.61343864   3.62095453
   3.66910974   3.67266144   3.72028776   3.73342035   3.78890895
   3.79128178   3.83322846   3.83537978   3.87222606   3.95918382
   3.97773046   3.99708739   4.04281696   4.05096733   4.05205273
   4.07940598   4.08049814   4.10987799   4.12733606   4.19042806
   4.20438441   4.21083472   4.22963157   4.2772858    4.27740358
   4.3032652    4.35479635   4.37840042   4.38615224   4.40841573
   4.41215324   4.44810021   4.52230352   4.53201013   4.54607701
   4.57967689   4.58032203   4.5814785    4.65349794   4.69680087
   4.79217618   4.79743656   4.82459006   5.00953201   5.0438797
   5.04928481   5.0881878    5.10999306   5.13719427   5.15621098
   5.18273968   5.21243644   5.25545235   5.30600292   5.39391042
   5.40284417   5.48398863   5.55525594   5.58478719   5.61682504
   5.62106511   5.62289694   5.6435687    5.65643913   5.73549772
   5.76523641   5.78004065   5.79757372   5.87545831   6.18669917
   6.18908502   6.19987625   6.22095673   6.25986648  12.91456697
  13.80674289  13.90422136]
E1 = -320.419938984603  E_coul = 119.88738297569286
cycle= 1 E= -118.278420749281  delta_E= 0.208  |g|= 0.28  |ddm|= 1.79
    CPU time for cycle= 1      3.00 sec, wall time      1.00 sec
  HOMO = -0.475804372104889  LUMO = 0.134658091727687
  mo_energy =
[-11.25831399 -11.23095101 -11.23092979  -1.07208752  -0.94264546
  -0.81768698  -0.63470088  -0.60714744  -0.5588264   -0.5384994
  -0.48325434  -0.48276135  -0.47580437   0.13465809   0.17207221
   0.17862487   0.18606574   0.21234509   0.22762609   0.23772804
   0.25695754   0.28800824   0.35788976   0.3736681    0.3771455
   0.39772522   0.43182707   0.43443434   0.47593971   0.51642965
   0.57435493   0.57900201   0.60744516   0.6118864    0.63439051
   0.64444127   0.65451563   0.66759107   0.66972047   0.67945601
   0.72168557   0.75730044   0.80993187   0.88579174   0.88967935
   0.90833915   0.94898095   0.97053203   1.05780277   1.07176819
   1.11946911   1.14319794   1.16929729   1.1915344    1.20990289
   1.23724918   1.26084593   1.28749575   1.29673831   1.31374677
   1.33508812   1.35958107   1.37865192   1.39280221   1.39747145
   1.4352518    1.45273339   1.4753169    1.50601767   1.51710065
   1.53751228   1.57200834   1.59892059   1.60989827   1.63485699
   1.68503585   1.72812783   1.73513205   1.78107798   1.80644207
   1.84523499   1.89879348   2.47185625   2.52452471   2.53446903
   2.59322847   2.61358123   2.65806644   2.72317477   2.74721961
   2.76666473   2.79792346   2.80579967   2.83696497   2.91982008
   2.92867938   2.95591564   3.00571645   3.06622747   3.0913862
   3.11452673   3.11609834   3.11990111   3.13992326   3.19926782
   3.21612459   3.22456634   3.31885258   3.32207863   3.35188203
   3.35362279   3.35636678   3.38143708   3.39384252   3.41454158
   3.44662335   3.46104705   3.47624591   3.5003064    3.55457143
   3.57831921   3.62177312   3.65013998   3.66964612   3.67701539
   3.7213319    3.72204605   3.77073798   3.78426434   3.83322441
   3.84412631   3.88181436   3.8854369    3.92270417   4.01561873
   4.02737173   4.04836647   4.09939401   4.10294212   4.10499757
   4.12548746   4.12997461   4.16021928   4.1869336    4.24073231
   4.24907857   4.26189911   4.27707181   4.3231733    4.32394703
   4.35010788   4.39269034   4.42427228   4.43765901   4.44376764
   4.45973374   4.50082086   4.56236153   4.58291375   4.59558324
   4.61991732   4.6242314    4.64975308   4.70479612   4.74565781
   4.84643237   4.86025381   4.87436256   5.06519986   5.09418935
   5.11048908   5.13846123   5.1641581    5.19041028   5.21678957
   5.23421855   5.2660762    5.3136724    5.36466841   5.45447397
   5.46830095   5.54542756   5.61804956   5.64636911   5.67680758
   5.68177834   5.68664919   5.70514838   5.71537293   5.79563703
   5.82602662   5.8484611    5.85670262   5.94698745   6.26286747
   6.26565196   6.27601886   6.29726838   6.32934398  12.96428065
  13.87215909  13.97003985]
E1 = -321.0090673844262  E_coul = 120.44989115914385
cycle= 2 E= -118.305040965653  delta_E= -0.0266  |g|= 0.0752  |ddm|= 0.202
    CPU time for cycle= 2      4.88 sec, wall time      1.26 sec
  HOMO = -0.460228435946488  LUMO = 0.141442093433957
  mo_energy =
[-11.19594762 -11.19590577 -11.192543    -1.04113748  -0.91784959
  -0.79236664  -0.61454718  -0.58844856  -0.54201454  -0.52452546
  -0.46611051  -0.46534741  -0.46022844   0.14144209   0.17807725
   0.18522437   0.19231872   0.21997473   0.233832     0.24317583
   0.26341      0.29897728   0.37003573   0.38118461   0.38424191
   0.40756515   0.44477973   0.44521655   0.48511658   0.52483617
   0.58793003   0.59250159   0.62329884   0.62753295   0.64804954
   0.65881713   0.67819992   0.68535216   0.68671768   0.69985092
   0.73481392   0.77204749   0.82140625   0.89583993   0.9009906
   0.91957783   0.96033006   0.9818654    1.0717829    1.08145097
   1.12906398   1.15577508   1.1818774    1.20305245   1.2232058
   1.24989072   1.27439983   1.30287466   1.30900626   1.32509704
   1.35199467   1.36952861   1.39363282   1.40445021   1.41506044
   1.44636339   1.46756886   1.48878219   1.51858256   1.53199867
   1.5492852    1.5832307    1.61226931   1.62442825   1.64491804
   1.69862838   1.74637079   1.7481237    1.79660117   1.82373286
   1.86048254   1.91844185   2.49053162   2.54543253   2.55580423
   2.61444485   2.64009529   2.68147245   2.74487405   2.7658489
   2.78813545   2.82061023   2.83369814   2.86367456   2.94606517
   2.95207793   2.98474387   3.03166629   3.08918192   3.11619315
   3.13605982   3.13671817   3.14129513   3.1645608    3.22267783
   3.2389623    3.24840543   3.34223534   3.34358016   3.37557899
   3.37690484   3.37897372   3.4042766    3.41578542   3.43911905
   3.47068105   3.4833403    3.50520546   3.52823557   3.57762847
   3.60222101   3.63893171   3.66873943   3.69045596   3.69978255
   3.73984913   3.74096889   3.78888989   3.80275547   3.85363988
   3.86535929   3.90051131   3.90406957   3.94240175   4.03920868
   4.04624555   4.07013989   4.11808738   4.12790427   4.12816117
   4.14388631   4.15065167   4.17930162   4.21521949   4.26202037
   4.26750662   4.28141159   4.29641294   4.34212932   4.34423876
   4.36912195   4.40809298   4.44332886   4.45883767   4.45940753
   4.47820514   4.52221421   4.57925973   4.60275821   4.61736593
   4.63756193   4.64233586   4.67549753   4.7259855    4.76687903
   4.86815897   4.88575557   4.89620352   5.08840019   5.11480532
   5.13317674   5.15772657   5.18572711   5.21419565   5.24078968
   5.25492422   5.29022824   5.33716258   5.38785815   5.47509508
   5.49228516   5.56786076   5.64092907   5.67023383   5.69746551
   5.70275303   5.71057664   5.7281743    5.73659069   5.82288363
   5.84992035   5.87488225   5.88214163   5.97984521   6.28822489
   6.29078644   6.30134596   6.32283343   6.36371913  13.00731039
  13.90099641  13.99736412]
E1 = -320.7644595866325  E_coul = 120.20329878415477
cycle= 3 E= -118.307025542848  delta_E= -0.00198  |g|= 0.0239  |ddm|= 0.0685
    CPU time for cycle= 3      5.04 sec, wall time      1.26 sec
  HOMO = -0.466830158639186  LUMO = 0.140199785046082
  mo_energy =
[-11.2205633  -11.21160997 -11.21157861  -1.05021848  -0.92359976
  -0.79859139  -0.62125511  -0.59502517  -0.54853136  -0.5293304
  -0.4747776   -0.47433092  -0.46683016   0.14019979   0.17735357
   0.18407192   0.1909598    0.21882292   0.23232915   0.24236639
   0.26240498   0.29667999   0.36747191   0.37938674   0.38234281
   0.40427973   0.44144541   0.44216397   0.48280371   0.52335586
   0.58378607   0.58825459   0.61881393   0.62373115   0.64453254
   0.65663074   0.67269821   0.67985727   0.68193026   0.69340118
   0.73163464   0.76844175   0.81860876   0.89323535   0.89735667
   0.91689201   0.95776717   0.97943461   1.06693916   1.07998759
   1.12785894   1.15222329   1.17840056   1.19998369   1.21978028
   1.24634782   1.27073282   1.29730206   1.30593228   1.32247463
   1.34650622   1.36777741   1.38888874   1.40165208   1.409021
   1.44377593   1.46333865   1.48463543   1.5147586    1.52749632
   1.54662268   1.57988531   1.608475     1.62060243   1.64195002
   1.69497543   1.7419343    1.7447408    1.79279644   1.82048244
   1.8560943    1.91306566   2.48692689   2.54080224   2.55048965
   2.60932221   2.6301933    2.67433842   2.73895686   2.76183264
   2.78298702   2.81362428   2.82315896   2.85398067   2.93720464
   2.94442496   2.97469586   3.02285127   3.08234137   3.10844176
   3.13035731   3.13108705   3.13558102   3.15604733   3.21528877
   3.23359527   3.24080627   3.33551523   3.33728661   3.36868927
   3.36987542   3.37222556   3.39747809   3.40971518   3.43142763
   3.46415902   3.47750463   3.49584029   3.52056189   3.57141619
   3.59563159   3.63758802   3.66638363   3.68579239   3.69401114
   3.73678486   3.73686646   3.78541971   3.79928373   3.84955868
   3.85983985   3.8970793    3.90040258   3.93792536   4.03372924
   4.04296306   4.06613212   4.11567023   4.12108908   4.12324285
   4.14211111   4.14746919   4.17620062   4.20723357   4.25828129
   4.26614203   4.2782837    4.29316136   4.33938909   4.33965502
   4.36702129   4.40734487   4.44003823   4.45459024   4.45853738
   4.47572482   4.51758253   4.57797632   4.59896554   4.61212384
   4.63590108   4.64000743   4.66915369   4.72225886   4.76303633
   4.86310948   4.88043468   4.89099389   5.08198104   5.11073118
   5.12697502   5.15435395   5.18137816   5.2087745    5.23447676
   5.25124299   5.28490835   5.33133935   5.3824977    5.47015878
   5.48684476   5.56196791   5.63572552   5.66515639   5.69423352
   5.69950709   5.70537218   5.72320707   5.73327231   5.81636979
   5.8441254    5.86794708   5.87560705   5.96999495   6.28340779
   6.28574536   6.29611519   6.3177611    6.35436589  12.99069243
  13.89006336  13.98714209]
E1 = -320.8877250237104  E_coul = 120.32640421182982
cycle= 4 E= -118.307185552251  delta_E= -0.00016  |g|= 0.00346  |ddm|= 0.0178
    CPU time for cycle= 4      5.01 sec, wall time      1.27 sec
  HOMO = -0.466642329437351  LUMO = 0.14034326365355
  mo_energy =
[-11.21930813 -11.2114708  -11.21143646  -1.04943265  -0.92325591
  -0.79828217  -0.62082303  -0.59484595  -0.54841632  -0.52919786
  -0.47468217  -0.47416297  -0.46664233   0.14034326   0.17735264
   0.18423084   0.1911965    0.21891146   0.23253714   0.24244047
   0.26255159   0.29686324   0.36753978   0.37943051   0.3823717
   0.40427244   0.44165982   0.44233271   0.48295448   0.52332845
   0.58405542   0.5886503    0.61906693   0.62384936   0.6447559
   0.65654275   0.67315345   0.68005518   0.68225609   0.69355716
   0.73178477   0.76860948   0.81874818   0.89335519   0.89761081
   0.91715355   0.95782908   0.97959186   1.06725257   1.08007465
   1.12790428   1.15249144   1.17853124   1.20010922   1.21979394
   1.2464195    1.27087189   1.29769409   1.30605413   1.32255041
   1.34664223   1.36790157   1.38912455   1.40181295   1.40924016
   1.44394318   1.46345213   1.48495984   1.51500509   1.52777518
   1.54671409   1.58013083   1.60873452   1.62079177   1.64213203
   1.69508472   1.7420771    1.74490192   1.79294581   1.82041182
   1.85623028   1.91320908   2.4871503    2.54103148   2.55068971
   2.60940554   2.63071518   2.67476684   2.73922351   2.76189817
   2.78336624   2.81409908   2.8237973    2.85446007   2.9375452
   2.94474157   2.97518165   3.02319952   3.08263279   3.10868304
   3.13039926   3.13123616   3.13572803   3.15656548   3.21545422
   3.23359426   3.24097115   3.3357514    3.33754934   3.36893209
   3.36999184   3.3725641    3.39755501   3.4098142    3.4318394
   3.46438243   3.47757643   3.4963079    3.52084373   3.57171982
   3.59596833   3.63752425   3.66634855   3.68580544   3.69438288
   3.73700857   3.73706167   3.78567911   3.79945555   3.84986564
   3.86026273   3.89717474   3.9006735    3.93819162   4.03414496
   4.04301071   4.06647773   4.1159178    4.12148755   4.12352049
   4.14206695   4.14783745   4.17651045   4.20755792   4.25848728
   4.26618866   4.2785145    4.29337068   4.33954465   4.33985893
   4.36722781   4.40751927   4.440186     4.45474225   4.45867307
   4.47587837   4.51775005   4.5781302    4.59922719   4.6125067
   4.63610577   4.64005013   4.66922213   4.72254871   4.76327561
   4.86342553   4.88052434   4.89135195   5.08245643   5.11091936
   5.12720236   5.15457503   5.18156366   5.20910215   5.23466148
   5.25151965   5.28521031   5.33151482   5.38278844   5.47041226
   5.4870921    5.56229874   5.63590018   5.66541078   5.69419152
   5.6994818    5.70546852   5.72348847   5.73323064   5.8166587
   5.8444578    5.86828591   5.87602441   5.97049127   6.28332213
   6.28580847   6.29621312   6.31773426   6.35477677  12.99144662
  13.89028911  13.98729329]
E1 = -320.87753436275733  E_coul = 120.31620846155677
cycle= 5 E= -118.307190641571  delta_E= -5.09e-06  |g|= 0.000662  |ddm|= 0.00402
    CPU time for cycle= 5      5.26 sec, wall time      1.30 sec
  HOMO = -0.466680304769281  LUMO = 0.140338215835044
  mo_energy =
[-11.21949883 -11.21131923 -11.2112858   -1.04950378  -0.92324633
  -0.79828065  -0.6208488   -0.59485487  -0.54844848  -0.52921457
  -0.47477326  -0.47424371  -0.4666803    0.14033822   0.17737158
   0.18423397   0.19119077   0.2189358    0.2325405    0.24245189
   0.26254538   0.29684912   0.36754823   0.3794311    0.38235083
   0.40426403   0.4416242    0.44230989   0.48294238   0.52332251
   0.58404247   0.5886156    0.61903895   0.62383248   0.64474769
   0.65657424   0.67309314   0.68004416   0.68224455   0.69354436
   0.73178887   0.76862224   0.81871702   0.89332588   0.89756658
   0.91710606   0.95784174   0.97957499   1.06719637   1.08006076
   1.12789564   1.15246639   1.17850484   1.2001017    1.2198073
   1.24640534   1.27087557   1.29763623   1.3060526    1.32255554
   1.34661155   1.36790637   1.38909644   1.40180953   1.40921066
   1.44391195   1.46344682   1.48493433   1.51497396   1.52775229
   1.5467391    1.58009595   1.60871884   1.6207874    1.64208971
   1.69508165   1.74210415   1.74489315   1.79294351   1.82046404
   1.85622189   1.91321576   2.48712117   2.54101553   2.55070603
   2.60943354   2.63064815   2.67471481   2.73918755   2.76189837
   2.78333659   2.81403547   2.82372066   2.85440903   2.93752741
   2.94472602   2.97512847   3.02318951   3.08259708   3.10867946
   3.13042144   3.13120794   3.13571244   3.15650182   3.2154557
   3.23360736   3.24096314   3.33571999   3.33754233   3.3689196
   3.3700103    3.37253893   3.39756202   3.40981232   3.43180902
   3.46438855   3.47761637   3.49623626   3.52081445   3.57170023
   3.59593526   3.63756256   3.66638232   3.68586034   3.69435788
   3.73703099   3.73703397   3.78566605   3.79946499   3.84986024
   3.86021724   3.8972035    3.90066294   3.93817931   4.03413434
   4.04306039   4.06648149   4.11591797   4.12147485   4.12352494
   4.14213472   4.14783196   4.17649338   4.20755773   4.25852379
   4.26625943   4.27849182   4.29336423   4.33958463   4.3398571
   4.3672417    4.40753386   4.44021596   4.4547764    4.45870213
   4.47589531   4.51776734   4.57816866   4.59922315   4.61249192
   4.6361352    4.64011289   4.66926332   4.72255235   4.76330704
   4.86341237   4.88055686   4.89135354   5.08240171   5.11094463
   5.12718936   5.15457875   5.18158562   5.2090988    5.2346632
   5.25151664   5.28521952   5.33154207   5.38278836   5.47039371
   5.48711924   5.56225742   5.63592114   5.66540954   5.69424728
   5.69953134   5.70551679   5.7234786    5.73329591   5.8166613
   5.84444598   5.8682724    5.87599088   5.97046011   6.28340485
   6.2858303    6.29622969   6.3178075    6.35474011  12.99135142
  13.89034698  13.98736771]
E1 = -320.8774867000452  E_coul = 120.31616054696605
cycle= 6 E= -118.30719089345  delta_E= -2.52e-07  |g|= 0.000162  |ddm|= 0.00117
    CPU time for cycle= 6      5.08 sec, wall time      1.31 sec
  HOMO = -0.466685200593901  LUMO = 0.140333224791418
  mo_energy =
[-11.21945438 -11.21142117 -11.21138734  -1.04952618  -0.92328117
  -0.79830188  -0.62085174  -0.59488162  -0.54847289  -0.5292284
  -0.4748114   -0.47426412  -0.4666852    0.14033322   0.17736326
   0.184233     0.19119301   0.21892888   0.23254272   0.2424488
   0.26254564   0.29684639   0.36754304   0.3794209    0.38234577
   0.40424652   0.44161407   0.44230505   0.48293845   0.52331513
   0.58403267   0.58861503   0.61902714   0.62381787   0.64473746
   0.6565536    0.67308227   0.68003602   0.68224018   0.6935254
   0.73178166   0.76861313   0.81870716   0.89331785   0.89755726
   0.91710513   0.9578281    0.97957094   1.06718281   1.08005452
   1.12788923   1.15245904   1.17849558   1.20008926   1.2197935
   1.24639176   1.27086293   1.29763237   1.306046     1.32254793
   1.34659866   1.36790494   1.38908714   1.4018017    1.40919852
   1.44391061   1.46343313   1.4849285    1.51496424   1.52773924
   1.54672765   1.58008514   1.60871605   1.62077823   1.64207978
   1.69506953   1.74209544   1.7448832    1.79293524   1.82044392
   1.85621024   1.91320715   2.48711409   2.5410124    2.55068538
   2.60940939   2.63062642   2.67470095   2.73917417   2.76188112
   2.78333295   2.8140296    2.823703     2.85439118   2.93750494
   2.94470194   2.97511183   3.0231665    3.08258031   3.10865617
   3.13039279   3.13118265   3.13569043   3.15648061   3.21542813
   3.2335923    3.24094065   3.33570215   3.33751374   3.36889975
   3.3699805    3.37251436   3.39753345   3.40978929   3.43179027
   3.46437694   3.47758607   3.49623407   3.52081259   3.57169583
   3.59592536   3.63755585   3.66637318   3.68583576   3.69434815
   3.73701378   3.7370273    3.78565686   3.79944783   3.84986195
   3.86020807   3.89719071   3.90065358   3.93817061   4.0341255
   4.043046     4.06648149   4.11591533   4.12146285   4.12352437
   4.14212501   4.14783467   4.1764914    4.20755111   4.25851373
   4.2662503    4.27849283   4.29336407   4.33958022   4.33984894
   4.36724316   4.40753683   4.44020532   4.45476663   4.45870449
   4.47589263   4.51775842   4.57816981   4.59921747   4.61248875
   4.63613716   4.64010206   4.66924255   4.72255124   4.76330085
   4.86340403   4.88054779   4.89134784   5.0823935    5.11093406
   5.12717327   5.15456945   5.18157124   5.20909483   5.23465077
   5.25151257   5.28521758   5.33152138   5.38277601   5.47037208
   5.48709717   5.56224277   5.63590197   5.66540346   5.69423111
   5.69951698   5.70549548   5.72347136   5.73327968   5.81665821
   5.84443708   5.86825915   5.87598575   5.97045125   6.28337395
   6.2858116    6.29621199   6.3177767    6.35474522  12.99136593
  13.8902915   13.9873074 ]
E1 = -320.8775781617805  E_coul = 120.3162519939747
cycle= 7 E= -118.307190908176  delta_E= -1.47e-08  |g|= 4.18e-05  |ddm|= 0.000333
    CPU time for cycle= 7      4.83 sec, wall time      1.28 sec
  HOMO = -0.466685399404983  LUMO = 0.140332788191997
  mo_energy =
[-11.21948698 -11.21139764 -11.21136396  -1.04952795  -0.92327848
  -0.7983054   -0.62085025  -0.59487864  -0.54846967  -0.5292223
  -0.47481061  -0.47426464  -0.4666854    0.14033279   0.17736279
   0.18423245   0.19119363   0.21892926   0.23254366   0.24244951
   0.26254658   0.29684626   0.36754258   0.37942165   0.382345
   0.40424549   0.44161449   0.44230567   0.48293907   0.52331534
   0.58403328   0.58861551   0.61902858   0.62381739   0.6447409
   0.65655522   0.6730822    0.68003427   0.68224224   0.69352501
   0.73178256   0.76861415   0.81870806   0.89331792   0.89755706
   0.91710521   0.95782899   0.97957102   1.06718469   1.08005496
   1.12788984   1.15245969   1.17849608   1.20009199   1.2197934
   1.24639275   1.27086325   1.29763195   1.30604548   1.32254851
   1.3465979    1.36790476   1.38908724   1.40180179   1.40919673
   1.44390975   1.46343356   1.48492986   1.51496555   1.52774182
   1.54672807   1.5800865    1.60871532   1.62077922   1.64208162
   1.69507095   1.74209406   1.74488481   1.79293605   1.82044718
   1.85620947   1.91320517   2.48711695   2.54101094   2.55068657
   2.60941183   2.6306268    2.67470132   2.73917531   2.76188462
   2.78333206   2.81402699   2.82370426   2.85439036   2.93750618
   2.94470566   2.97511191   3.02316791   3.08258197   3.10865784
   3.13039877   3.13118785   3.1356945    3.15648194   3.21543054
   3.23359467   3.24094216   3.3357051    3.33751949   3.36890114
   3.36998466   3.37251813   3.39753755   3.40979315   3.43179252
   3.46437541   3.47759266   3.49622732   3.52080776   3.57169487
   3.59592437   3.63755774   3.66637455   3.68583767   3.69434896
   3.73701661   3.73702997   3.78566031   3.79945107   3.84985985
   3.86020884   3.89719236   3.90065566   3.93817163   4.03412622
   4.0430474    4.06648166   4.1159171    4.12146438   4.12352418
   4.14212607   4.1478352    4.17649345   4.20754806   4.2585137
   4.26625233   4.27849389   4.29336401   4.33958023   4.33984717
   4.36724397   4.40753841   4.44020617   4.45476566   4.45870594
   4.47589385   4.51775868   4.57817063   4.59921924   4.61248832
   4.6361373    4.64010317   4.66924604   4.72255193   4.76330137
   4.86340493   4.88054778   4.89134825   5.08239248   5.11093594
   5.12717449   5.15457286   5.18157376   5.20909403   5.23465068
   5.2515143    5.28521633   5.331523     5.38277837   5.4703761
   5.487102     5.56224448   5.6359057    5.66540481   5.69423542
   5.69952124   5.70549913   5.72347382   5.73328348   5.81665458
   5.84443787   5.86826173   5.87598472   5.97044753   6.28338117
   6.28581813   6.29621817   6.31778391   6.35473636  12.99134993
  13.89030294  13.98732094]
E1 = -320.8775221204858  E_coul = 120.31619595191164
cycle= 8 E= -118.307190908945  delta_E= -7.68e-10  |g|= 8.17e-06  |ddm|= 7.89e-05
    CPU time for cycle= 8      5.20 sec, wall time      1.29 sec
  HOMO = -0.466685633488078  LUMO = 0.140332268901406
  mo_energy =
[-11.21948349 -11.21140426 -11.21137056  -1.04952938  -0.923281
  -0.79830621  -0.62085082  -0.5948799   -0.54847153  -0.52922499
  -0.47481191  -0.47426542  -0.46668563   0.14033227   0.17736235
   0.18423221   0.19119321   0.21892903   0.23254361   0.24244889
   0.26254559   0.29684538   0.36754192   0.3794213    0.38234438
   0.40424567   0.44161385   0.44230523   0.48293855   0.52331413
   0.5840328    0.58861524   0.61902721   0.6238162    0.64473937
   0.65655372   0.67308067   0.68003425   0.68224138   0.6935242
   0.73178193   0.76861358   0.81870686   0.893317     0.89755661
   0.91710418   0.95782848   0.97957029   1.06718311   1.08005395
   1.1278887    1.15245916   1.17849473   1.20009064   1.21979275
   1.24639148   1.27086286   1.29763123   1.30604523   1.32254775
   1.34659673   1.36790468   1.38908634   1.40180142   1.40919626
   1.44390878   1.46343247   1.48492901   1.51496421   1.52774026
   1.54672801   1.58008518   1.60871515   1.62077837   1.64207978
   1.69506965   1.74209416   1.74488374   1.79293477   1.82044526
   1.85620903   1.91320492   2.48711453   2.54101046   2.55068587
   2.6094106    2.63062536   2.67470003   2.7391736    2.76188239
   2.78333161   2.81402663   2.82370218   2.85438941   2.9375046
   2.94470371   2.97511017   3.02316679   3.08258033   3.10865644
   3.13039618   3.1311852    3.13569224   3.15648056   3.21542902
   3.23359274   3.24094046   3.33570285   3.33751705   3.36889995
   3.36998261   3.37251624   3.3975352    3.40979082   3.43179078
   3.46437535   3.47759002   3.49622756   3.52080815   3.57169408
   3.59592334   3.63755601   3.66637299   3.68583708   3.69434781
   3.73701527   3.73702758   3.78565817   3.79944937   3.84986
   3.86020739   3.89719127   3.90065413   3.93817059   4.03412538
   4.04304705   4.06648128   4.11591569   4.12146299   4.123523
   4.14212534   4.14783446   4.17649179   4.20754779   4.25851384
   4.26625164   4.27849189   4.29336262   4.33958034   4.33984682
   4.36724283   4.40753678   4.44020543   4.45476579   4.45870454
   4.47589268   4.51775761   4.57817007   4.59921767   4.6124879
   4.63613701   4.64010254   4.66924392   4.72255091   4.76330113
   4.8634039    4.88054677   4.89134754   5.08239198   5.11093464
   5.1271731    5.15457073   5.18157222   5.20909367   5.23464964
   5.25151266   5.2852164    5.33152193   5.38277667   5.47037402
   5.48710002   5.56224276   5.63590384   5.66540344   5.69423352
   5.69951921   5.70549756   5.72347186   5.73328191   5.81665542
   5.84443685   5.86825958   5.8759841    5.97044746   6.28337889
   6.28581489   6.29621501   6.31778158   6.35473796  12.99135157
  13.89029905  13.98731664]
E1 = -320.87754334109144  E_coul = 120.31621717249476
Extra cycle  E= -118.307190908967  delta_E= -2.25e-11  |g|= 3.1e-06  |ddm|= 1.14e-05
    CPU time for scf_cycle     52.63 sec, wall time     16.21 sec
    CPU time for SCF     52.64 sec, wall time     16.21 sec
converged SCF energy = -118.307190908967
