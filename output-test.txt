#INFO: **** input file is /Users/jaydenl/Dev/ASDRP/QCHEM/PySCF-UI/test.py ****
import streamlit as st
import streamlit.components.v1 as components
from pyscf import gto, scf
from streamlit.runtime.scriptrunner import add_script_run_ctx
import threading
import time
from stmol import *
import py3Dmol
from rdkit.Chem.rdmolfiles import MolFromXYZFile



if 'queue' not in st.session_state:
    st.session_state['queue'] = []
if 'results' not in st.session_state:
    st.session_state['results'] = []
if 'computing' not in st.session_state:
    st.session_state['computing'] = False


def compute_pyscf(atom, basis_option, verbose_option):
    # print(atom)
    # print(basis_option)
    # print(verbose_option)
    mol = gto.Mole()
    mol.atom = atom
    mol.basis = basis_option
    mol.verbose = int(verbose_option[0])
    mol.output = 'output-test.txt'
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    outputFile = open("output-test.txt", "r")
    # Extract energy and time information
    time = None
    energy = None
    for line in outputFile.readlines():
        if line.startswith("    CPU time for SCF"):
            time = float(line.split(" ")[-2])

        elif line.startswith("converged SCF energy = "):
            energy = float(line.split(" ")[-1])
    return energy, time


def getMoleculeName(atom):
    d = {}
    for line in atom.split("\n"):
        try:
            name = line.split()[0]
            if name in d:
                d[name] += 1
            else:
                d[name] = 1
        except:
            pass
    name = ""
    for key in d:
        name += key + str(d[key])
    return name


# Streamlit layout
st.title("PySCF")

# Function to process the uploaded text file


def process_text_file(uploaded_file):
    if uploaded_file is not None:
        # Read the contents of the file
        text_contents = uploaded_file.getvalue().decode("utf-8")
        return text_contents
    else:
        return None


# Display file uploader for a single text file and processes it
uploaded_file = st.file_uploader("Upload a XYZ input", type=["txt"])
text_contents = process_text_file(uploaded_file)

# Fills xyz_input text area to the contents of the uploaded file
xyz_input = st.text_area(
    "XYZ Input", value=text_contents) if text_contents else st.text_area("XYZ Input")

# Create a Streamlit button which gives example
with st.expander("See Example Input"):
    st.write("C 0.0000000 0.0000000 0.0000000")
    st.write("H 0.6311940 0.6311940 0.6311940")
    st.write("H -0.6311940 -0.6311940 0.6311940")
    st.write("H -0.6311940 0.6311940 -0.6311940")
    st.write("H 0.6311940 -0.6311940 -0.631194")


basis_option = st.selectbox("Basis", ["cc-pVTZ", "asdf"])
verbose_option = st.selectbox("Verbose", index=2, options=[
                              "3, energy only", "4, cycles and energy", "5, cycles energy and runtime", "9, max"])

col1, col2, col3 = st.columns(3, gap="small")


def addToQueue(atom):
    st.session_state['queue'].append(atom)


if col1.button("Add to Queue"):
    if xyz_input:
        addToQueue(xyz_input)
    else:
        st.warning(
            "Please provide an XYZ input using the text box or inputting a text file.")

if 'queue' in st.session_state:
    st.subheader("Queue")
    for queue_item in st.session_state['queue']:
        st.write(getMoleculeName(queue_item))


if 'results' in st.session_state:
    st.subheader("Results")
    for result_item in st.session_state['results']:
        with st.container():
            result_col_1, result_col_2 = st.columns([2,1])
            result_col_1.write(
                f"{result_item[0]} | Energy: {result_item[1]} | Time: {result_item[2]} seconds")
            with result_col_2:
                speck_plot(result_item[3], component_h=200, component_w=200, wbox_height="auto", wbox_width="auto")

if col3.button('View Log'):
    with open('output-test.txt', 'r') as file:
        log_data = file.read()
        st.markdown(f'```\n{log_data}\n```')

# Computes only if something is added to the queue; grayed out otherwise
compute_disabled = len(st.session_state['queue']) == 0
if col2.button("Compute", disabled=compute_disabled) or st.session_state['computing'] == True:
    if len(st.session_state['queue']) > 0:
        with st.spinner("Computing " + getMoleculeName(st.session_state['queue'][0]) + "..."):
            st.session_state['computing'] = True
            atom = st.session_state['queue'][0]
            st.session_state['queue'].pop(0)
            # st.write("Computing...")
            # progress_text = "Computing..."
            # my_bar = st.progress(0, text=progress_text)

            # for percent_complete in range(100):
            #     time.sleep(0.01)
            #     my_bar.progress(percent_complete + 1, text=progress_text)
            # time.sleep(1)
            # my_bar.empty()
            
            # Delete empty lines
            parsed = [line for line in atom.splitlines() if line.strip() != ""]
            xyz = "\n".join(parsed)
            mol = f"{len(parsed)}\nname\n{str(xyz)}"
            print(mol)
            # st.success(mol.splitlines()[1],icon="âœ…")
            # res = speck_plot(mol)
            
            energy, time_val = compute_pyscf(
                atom, basis_option, verbose_option)
            molecule_name = getMoleculeName(atom)
            st.session_state['results'].append(
                (molecule_name, energy, time_val, mol))
            st.rerun()
    elif st.session_state['computing'] == True:
        st.session_state['computing'] = False
    else:
        st.warning("Please add an XYZ input to the queue.")
        
# xyzview = py3Dmol.view(query='pdb:1A2C') 
# xyzview.setStyle({'cartoon':{'color':'spectrum'}})
# showmol(xyzview, height = 500,width=800)

# def draw_with_spheres(mol):
#     v = py3Dmol.view(width=300,height=300)
#     IPythonConsole.addMolToView(mol,v)
#     v.zoomTo()
#     v.setStyle({'sphere':{'radius':0.3},'stick':{'radius':0.2}});
#     v.show()


# Attempt at creating an async queue, need to find a way to detect browser closing to stop the queue

# def runQueue():
#     for i in range(1, 10):
#         time.sleep(1)
#         print("test", str(i))


# if 'queue-running' not in st.session_state:
#     st.session_state['queue-running'] = True
#     t = threading.Thread(target=runQueue)
#     add_script_run_ctx(t)
#     t.start()

# components.html("""<html>
# <script>
#     const origClose = window.close;
#     window.close = () => {
#         console.log("asdf");
#         // origClose();
#     }
#     document.addEventListener("beforeunload", () => {
#                 alert(1);
#                 console.log(a.a.a.a);
#     })
# </script>
# <div style="color: white" onclick="">
#                 hihihihi
# </div>
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Jaydens-MacBook.local', release='23.0.0', version='Darwin Kernel Version 23.0.0: Fri Sep 15 14:41:34 PDT 2023; root:xnu-10002.1.13~1/RELEASE_ARM64_T8103', machine='arm64', processor='arm')  Threads 1
Python 3.8.18 | packaged by conda-forge | (default, Oct 10 2023, 15:46:56) 
[Clang 16.0.6 ]
numpy 1.24.4  scipy 1.10.1
Date: Mon Nov 20 20:10:52 2023
PySCF version 2.4.0
PySCF path  /Users/jaydenl/anaconda3/envs/pyscfui/lib/python3.8/site-packages/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 5
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 5
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 C      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H      0.631194000000   0.631194000000   0.631194000000 AA    1.192783791469   1.192783791469   1.192783791469 Bohr   0.0
[INPUT]  3 H     -0.631194000000  -0.631194000000   0.631194000000 AA   -1.192783791469  -1.192783791469   1.192783791469 Bohr   0.0
[INPUT]  4 H     -0.631194000000   0.631194000000  -0.631194000000 AA   -1.192783791469   1.192783791469  -1.192783791469 Bohr   0.0
[INPUT]  5 H      0.631194000000  -0.631194000000  -0.631194000000 AA    1.192783791469  -1.192783791469  -1.192783791469 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] H
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1
[INPUT] C
[INPUT] 0    0    [8    /2   ]  8236              0.000531 -0.000113
                                1235              0.004108 -0.000878
                                280.8             0.021087 -0.00454
                                79.27             0.081853 -0.018133
                                25.59             0.234817 -0.05576
                                8.997             0.434401 -0.126895
                                3.319             0.346129 -0.170352
                                0.3643            -0.008983 0.598684
[INPUT] 0    0    [1    /1   ]  0.9059               1
[INPUT] 0    0    [1    /1   ]  0.1285               1
[INPUT] 1    0    [3    /1   ]  18.71             0.014031
                                4.133             0.086866
                                1.2               0.290216
[INPUT] 1    0    [1    /1   ]  0.3827               1
[INPUT] 1    0    [1    /1   ]  0.1209               1
[INPUT] 2    0    [1    /1   ]  1.097                1
[INPUT] 2    0    [1    /1   ]  0.318                1
[INPUT] 3    0    [1    /1   ]  0.761                1

nuclear repulsion = 13.3953252202033
number of shells = 33
number of NR pGTOs = 106
number of NR cGTOs = 86
basis = cc-pVTZ
ecp = {}
CPU time:         4.34


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /var/folders/_x/xd2ms3z958s6pfllwphw48vm0000gn/T/tmp20j5i8vf
max_memory 4000 MB (current use 0 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
E1 = -78.69835594961363  E_coul = 25.286414212785257
init E= -40.0166165166251
cond(S) = 3451.726973206357
    CPU time for initialize scf      3.59 sec, wall time      0.56 sec
  HOMO = -0.4713686207456  LUMO = 0.100359916059524
  mo_energy =
[-11.32313795  -1.23886249  -0.47136862  -0.47136862  -0.47136862
   0.10035992   0.19783343   0.19783343   0.19783343   0.34346056
   0.34346056   0.34346056   0.55718797   0.574813     0.574813
   0.574813     0.64411313   0.64411313   0.71828424   1.04150231
   1.04150231   1.04150231   1.11590629   1.11590629   1.11590629
   1.28435608   1.28435608   1.28435608   1.48924431   1.48924431
   1.48924431   1.55774055   1.55774055   1.72578109   2.35868034
   2.35868034   2.35868034   2.49565074   2.90980962   2.90980962
   2.90980962   3.05272565   3.05272565   3.05581536   3.05581536
   3.05581536   3.22376714   3.22376714   3.22376714   3.55348416
   3.55348416   3.55348416   3.66696188   3.66696188   3.66696188
   3.73719811   3.73719811   3.80918321   4.03182842   4.03182842
   4.03182842   4.06112277   4.06112277   4.33404633   4.33404633
   4.33404633   4.47065286   4.47065286   4.47065286   4.72999148
   4.98439671   4.98439671   4.98439671   5.40098708   5.40098708
   5.40098708   5.42166613   5.42166613   5.42166613   5.4753033
   5.54892813   5.54892813   6.10889374   6.10889374   6.10889374
  14.31864574]
E1 = -79.58281749061693  E_coul = 25.98222263043855
cycle= 1 E= -40.2052696399751  delta_E= -0.189  |g|= 0.154  |ddm|= 1.08
    CPU time for cycle= 1      0.96 sec, wall time      0.14 sec
  HOMO = -0.548579529600198  LUMO = 0.139327482561439
  mo_energy =
[-11.21236329  -0.95402465  -0.54857953  -0.54857953  -0.54857953
   0.13932748   0.22538324   0.22538324   0.22538324   0.36149843
   0.36149843   0.36149843   0.63147019   0.63857536   0.63857536
   0.63857536   0.67552054   0.67552054   0.74973486   1.06679553
   1.06679553   1.06679553   1.15309985   1.15309985   1.15309985
   1.31226885   1.31226885   1.31226885   1.52768223   1.52768223
   1.52768223   1.59076019   1.59076019   1.78906754   2.41485368
   2.41485368   2.41485368   2.55842752   2.97982397   2.97982397
   2.97982397   3.12543694   3.12543694   3.12543694   3.12779366
   3.12779366   3.29810451   3.29810451   3.29810451   3.60224084
   3.60224084   3.60224084   3.72083166   3.72083166   3.72083166
   3.78699593   3.78699593   3.85695827   4.08048867   4.08048867
   4.08048867   4.10684892   4.10684892   4.36637319   4.36637319
   4.36637319   4.51369268   4.51369268   4.51369268   4.80738178
   5.03243975   5.03243975   5.03243975   5.46559295   5.46559295
   5.46559295   5.48754429   5.48754429   5.48754429   5.54019575
   5.61021782   5.61021782   6.19184047   6.19184047   6.19184047
  14.39755491]
E1 = -79.66107125875953  E_coul = 26.053162557447116
cycle= 2 E= -40.2125834811091  delta_E= -0.00731  |g|= 0.0365  |ddm|= 0.0947
    CPU time for cycle= 2      3.32 sec, wall time      0.52 sec
  HOMO = -0.541912600704652  LUMO = 0.143278625770127
  mo_energy =
[-11.20272296  -0.93980597  -0.5419126   -0.5419126   -0.5419126
   0.14327863   0.22912203   0.22912203   0.22912203   0.36509284
   0.36509284   0.36509284   0.64067839   0.64686947   0.64686947
   0.64686947   0.6842211    0.6842211    0.75548422   1.07376388
   1.07376388   1.07376388   1.15933832   1.15933832   1.15933832
   1.31829755   1.31829755   1.31829755   1.53414866   1.53414866
   1.53414866   1.59750157   1.59750157   1.80058769   2.42750591
   2.42750591   2.42750591   2.56947088   2.99039105   2.99039105
   2.99039105   3.13780312   3.13780312   3.13780312   3.14010034
   3.14010034   3.30896967   3.30896967   3.30896967   3.61549689
   3.61549689   3.61549689   3.733086     3.733086     3.733086
   3.79859989   3.79859989   3.86955765   4.0948756    4.0948756
   4.0948756    4.12147669   4.12147669   4.37894186   4.37894186
   4.37894186   4.52588931   4.52588931   4.52588931   4.8241197
   5.04502589   5.04502589   5.04502589   5.47995863   5.47995863
   5.47995863   5.50045946   5.50045946   5.50045946   5.55435304
   5.62383333   5.62383333   6.20787153   6.20787153   6.20787153
  14.40780175]
E1 = -79.64541387011286  E_coul = 26.036962076720965
cycle= 3 E= -40.2131265731886  delta_E= -0.000543  |g|= 0.00544  |ddm|= 0.0348
    CPU time for cycle= 3      3.62 sec, wall time      0.52 sec
  HOMO = -0.544098779488303  LUMO = 0.143052020463489
  mo_energy =
[-11.21068393  -0.94171194  -0.54409878  -0.54409878  -0.54409878
   0.14305202   0.22882142   0.22882142   0.22882142   0.36449442
   0.36449442   0.36449442   0.63959872   0.64550036   0.64550036
   0.64550036   0.68330034   0.68330034   0.75490336   1.0732846
   1.0732846    1.0732846    1.15807588   1.15807588   1.15807588
   1.31770528   1.31770528   1.31770528   1.53287996   1.53287996
   1.53287996   1.59661888   1.59661888   1.79910935   2.42628648
   2.42628648   2.42628648   2.56752607   2.98754045   2.98754045
   2.98754045   3.13562113   3.13562113   3.13562113   3.13741986
   3.13741986   3.30591721   3.30591721   3.30591721   3.61479522
   3.61479522   3.61479522   3.73169607   3.73169607   3.73169607
   3.79748954   3.79748954   3.86862263   4.09427576   4.09427576
   4.09427576   4.12097566   4.12097566   4.37884499   4.37884499
   4.37884499   4.52520204   4.52520204   4.52520204   4.82209211
   5.04393518   5.04393518   5.04393518   5.47834076   5.47834076
   5.47834076   5.49863294   5.49863294   5.49863294   5.55257915
   5.62226963   5.62226963   6.20536406   6.20536406   6.20536406
  14.40287662]
E1 = -79.6584289767366  E_coul = 26.049967019072295
cycle= 4 E= -40.213136737461  delta_E= -1.02e-05  |g|= 0.0016  |ddm|= 0.00446
    CPU time for cycle= 4      2.44 sec, wall time      0.61 sec
  HOMO = -0.543667775366322  LUMO = 0.143184927343291
  mo_energy =
[-11.20877599  -0.94101966  -0.54366778  -0.54366778  -0.54366778
   0.14318493   0.22897572   0.22897572   0.22897572   0.36460975
   0.36460975   0.36460975   0.63991848   0.64588803   0.64588803
   0.64588803   0.68364007   0.68364007   0.75504817   1.07346884
   1.07346884   1.07346884   1.15836902   1.15836902   1.15836902
   1.3179032    1.3179032    1.3179032    1.53324358   1.53324358
   1.53324358   1.59689094   1.59689094   1.7995993    2.42671617
   2.42671617   2.42671617   2.56802051   2.98823423   2.98823423
   2.98823423   3.13615835   3.13615835   3.13615835   3.1380584
   3.1380584    3.30664479   3.30664479   3.30664479   3.61516166
   3.61516166   3.61516166   3.73219087   3.73219087   3.73219087
   3.79789297   3.79789297   3.86904747   4.0946675    4.0946675
   4.0946675    4.12140023   4.12140023   4.37917906   4.37917906
   4.37917906   4.52558111   4.52558111   4.52558111   4.82278458
   5.04440632   5.04440632   5.04440632   5.47890704   5.47890704
   5.47890704   5.49914995   5.49914995   5.49914995   5.55317478
   5.62281382   5.62281382   6.20610647   6.20610647   6.20610647
  14.40407399]
E1 = -79.65477094851342  E_coul = 26.046307817751412
cycle= 5 E= -40.2131379105587  delta_E= -1.17e-06  |g|= 0.000221  |ddm|= 0.00217
    CPU time for cycle= 5      3.57 sec, wall time      0.69 sec
  HOMO = -0.543693514567448  LUMO = 0.14317776569861
  mo_energy =
[-11.20887595  -0.94106201  -0.54369351  -0.54369351  -0.54369351
   0.14317777   0.22897782   0.22897782   0.22897782   0.36460074
   0.36460074   0.36460074   0.63990087   0.64588116   0.64588116
   0.64588116   0.68364299   0.68364299   0.7550392    1.073466
   1.073466     1.073466     1.15835737   1.15835737   1.15835737
   1.31789852   1.31789852   1.31789852   1.53323815   1.53323815
   1.53323815   1.59688526   1.59688526   1.79959855   2.42671852
   2.42671852   2.42671852   2.56800186   2.98820934   2.98820934
   2.98820934   3.13614299   3.13614299   3.13614299   3.1380336
   3.1380336    3.30661704   3.30661704   3.30661704   3.61517218
   3.61517218   3.61517218   3.73219415   3.73219415   3.73219415
   3.79789283   3.79789283   3.8690595    4.09468593   4.09468593
   4.09468593   4.12142623   4.12142623   4.37920634   4.37920634
   4.37920634   4.52559302   4.52559302   4.52559302   4.8227878
   5.04441716   5.04441716   5.04441716   5.47891354   5.47891354
   5.47891354   5.49914339   5.49914339   5.49914339   5.55317892
   5.6228179    5.6228179    6.20610236   6.20610236   6.20610236
  14.40401627]
E1 = -79.65480828888883  E_coul = 26.046345126365694
cycle= 6 E= -40.2131379423198  delta_E= -3.18e-08  |g|= 2.73e-05  |ddm|= 0.000627
    CPU time for cycle= 6      2.96 sec, wall time      0.48 sec
  HOMO = -0.54369714529003  LUMO = 0.143174724636216
  mo_energy =
[-11.20888924  -0.94107056  -0.54369715  -0.54369715  -0.54369715
   0.14317472   0.22897654   0.22897654   0.22897654   0.36459796
   0.36459796   0.36459796   0.63989498   0.64587799   0.64587799
   0.64587799   0.68363988   0.68363988   0.75503564   1.07346326
   1.07346326   1.07346326   1.15835297   1.15835297   1.15835297
   1.31789556   1.31789556   1.31789556   1.53323471   1.53323471
   1.53323471   1.59688185   1.59688185   1.79959312   2.42671441
   2.42671441   2.42671441   2.56799528   2.98820232   2.98820232
   2.98820232   3.13613664   3.13613664   3.13613664   3.13802631
   3.13802631   3.30660945   3.30660945   3.30660945   3.6151692
   3.6151692    3.6151692    3.73219026   3.73219026   3.73219026
   3.79788879   3.79788879   3.86905631   4.09468355   4.09468355
   4.09468355   4.12142462   4.12142462   4.3792053    4.3792053
   4.3792053    4.5255902    4.5255902    4.5255902    4.82278262
   5.04441396   5.04441396   5.04441396   5.4789094    5.4789094
   5.4789094    5.49913783   5.49913783   5.49913783   5.5531743
   5.62281361   5.62281361   6.2060965    6.2060965    6.2060965
  14.40400715]
E1 = -79.65482683049677  E_coul = 26.046363667589493
cycle= 7 E= -40.213137942704  delta_E= -3.84e-10  |g|= 1.33e-06  |ddm|= 7.26e-05
    CPU time for cycle= 7      2.50 sec, wall time      0.35 sec
  HOMO = -0.543696890921637  LUMO = 0.143174744748645
  mo_energy =
[-11.20888848  -0.9410706   -0.54369689  -0.54369689  -0.54369689
   0.14317474   0.22897663   0.22897663   0.22897663   0.36459813
   0.36459813   0.36459813   0.63989518   0.64587825   0.64587825
   0.64587825   0.68364006   0.68364006   0.75503585   1.0734634
   1.0734634    1.0734634    1.15835323   1.15835323   1.15835323
   1.31789571   1.31789571   1.31789571   1.53323492   1.53323492
   1.53323492   1.59688204   1.59688204   1.79959343   2.42671472
   2.42671472   2.42671472   2.56799563   2.98820276   2.98820276
   2.98820276   3.13613704   3.13613704   3.13613704   3.13802677
   3.13802677   3.30660992   3.30660992   3.30660992   3.61516944
   3.61516944   3.61516944   3.73219053   3.73219053   3.73219053
   3.79788906   3.79788906   3.86905654   4.09468377   4.09468377
   4.09468377   4.12142482   4.12142482   4.37920545   4.37920545
   4.37920545   4.52559042   4.52559042   4.52559042   4.822783
   5.04441421   5.04441421   5.04441421   5.47890973   5.47890973
   5.47890973   5.49913819   5.49913819   5.49913819   5.55317464
   5.62281394   5.62281394   6.20609694   6.20609694   6.20609694
  14.40400768]
E1 = -79.65482533880335  E_coul = 26.046362175895332
Extra cycle  E= -40.2131379427047  delta_E= -7.32e-13  |g|= 3.54e-07  |ddm|= 1.39e-06
    CPU time for scf_cycle     26.09 sec, wall time      4.33 sec
    CPU time for SCF     26.09 sec, wall time      4.33 sec
converged SCF energy = -40.2131379427047
