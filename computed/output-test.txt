#INFO: **** input file is /Users/jaydenl/Dev/ASDRP/QCHEM/PySCF-UI/stream.py ****
import streamlit as st
import streamlit.components.v1 as components
from pyscf import gto, scf
from streamlit.runtime.scriptrunner import add_script_run_ctx
import threading
import time

if 'queue' not in st.session_state:
    st.session_state['queue'] = []
if 'results' not in st.session_state:
    st.session_state['results'] = []
if 'computing' not in st.session_state:
    st.session_state['computing'] = False


def compute_pyscf(atom, basis_option, verbose_option):
    print(atom)
    print(basis_option)
    print(verbose_option)
    mol = gto.Mole()
    mol.atom = atom
    mol.basis = basis_option
    mol.verbose = int(verbose_option[0])
    mol.output = 'computed/output-test.txt'
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    outputFile = open("computed/output-test.txt", "r")
    # Extract energy and time information
    time = None
    energy = None
    for line in outputFile.readlines():
        if line.startswith("    CPU time for SCF"):
            time = float(line.split(" ")[-2])

        elif line.startswith("converged SCF energy = "):
            energy = float(line.split(" ")[-1])
    return energy, time


def getMoleculeName(atom):
    d = {}
    for line in atom.split("\n"):
        try:
            name = line.split()[0]
            if name in d:
                d[name] += 1
            else:
                d[name] = 1
        except:
            pass
    name = ""
    for key in d:
        name += key + str(d[key])
    return name


# Streamlit layout
st.title("PySCF")

xyz_input = st.text_area("XYZ Input")

# Create a Streamlit button which gives example
with st.expander("See Example Input"):
    st.write("C 0.0000000 0.0000000 0.0000000")
    st.write("H 0.6311940 0.6311940 0.6311940")
    st.write("H -0.6311940 -0.6311940 0.6311940")
    st.write("H -0.6311940 0.6311940 -0.6311940")
    st.write("H 0.6311940 -0.6311940 -0.631194")


basis_option = st.selectbox("Basis", ["cc-pVTZ", "asdf"])
verbose_option = st.selectbox("Verbose", index=2, options=[
                              "3, energy only", "4, cycles and energy", "5, cycles energy and runtime", "9, max"])

col1, col2, col3 = st.columns(3, gap="small")


def addToQueue(atom):
    st.session_state['queue'].append(atom)


if col1.button("Add to Queue"):
    if xyz_input:
        addToQueue(xyz_input)
    else:
        st.warning("Please provide an XYZ input.")

if 'queue' in st.session_state:
    st.subheader("Queue")
    for queue_item in st.session_state['queue']:
        st.write(getMoleculeName(queue_item))

if 'results' in st.session_state:
    st.subheader("Results")
    for result_item in st.session_state['results']:
        st.write(
            f"{result_item[0]} | Energy: {result_item[1]} | Time: {result_item[2]} seconds")

if col3.button('View Log'):
    with open('computed/output-test.txt', 'r') as file:
        log_data = file.read()
        st.markdown(f'```\n{log_data}\n```')

if col2.button("Compute") or st.session_state['computing'] == True:
    if len(st.session_state['queue']) > 0:
        with st.spinner("Computing " + getMoleculeName(st.session_state['queue'][0]) + "..."):
            st.session_state['computing'] = True
            atom = st.session_state['queue'][0]
            st.session_state['queue'].pop(0)
            # st.write("Computing...")
            # progress_text = "Computing..."
            # my_bar = st.progress(0, text=progress_text)

            # for percent_complete in range(100):
            #     time.sleep(0.01)
            #     my_bar.progress(percent_complete + 1, text=progress_text)
            # time.sleep(1)
            # my_bar.empty()
            energy, time_val = compute_pyscf(
                atom, basis_option, verbose_option)
            molecule_name = getMoleculeName(atom)
            st.session_state['results'].append(
                (molecule_name, energy, time_val))
            st.rerun()
    elif st.session_state['computing'] == True:
        st.session_state['computing'] = False
    else:
        st.warning("Please add an XYZ input to the queue.")

# Attempt at creating an async queue, need to find a way to detect browser closing to stop the queue

# def runQueue():
#     for i in range(1, 10):
#         time.sleep(1)
#         print("test", str(i))


# if 'queue-running' not in st.session_state:
#     st.session_state['queue-running'] = True
#     t = threading.Thread(target=runQueue)
#     add_script_run_ctx(t)
#     t.start()

# components.html("""<html>
# <script>
#     const origClose = window.close;
#     window.close = () => {
#         console.log("asdf");
#         // origClose();
#     }
#     document.addEventListener("beforeunload", () => {
#                 alert(1);
#                 console.log(a.a.a.a);
#     })
# </script>
# <div style="color: white" onclick="">
#                 hihihihi
# </div>
#                 </html>""")
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='jaydens-macbook.lan', release='23.0.0', version='Darwin Kernel Version 23.0.0: Fri Sep 15 14:41:34 PDT 2023; root:xnu-10002.1.13~1/RELEASE_ARM64_T8103', machine='arm64', processor='arm')  Threads 1
Python 3.8.18 | packaged by conda-forge | (default, Oct 10 2023, 15:46:56) 
[Clang 16.0.6 ]
numpy 1.24.4  scipy 1.10.1
Date: Tue Nov  7 20:49:06 2023
PySCF version 2.4.0
PySCF path  /Users/jaydenl/anaconda3/envs/pyscfui/lib/python3.8/site-packages/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 5
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 5
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 C1     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H2     0.627600000000   0.627600000000   0.627600000000 AA    1.185992115777   1.185992115777   1.185992115777 Bohr   0.0
[INPUT]  3 H3     0.627600000000  -0.627600000000  -0.627600000000 AA    1.185992115777  -1.185992115777  -1.185992115777 Bohr   0.0
[INPUT]  4 H4    -0.627600000000   0.627600000000  -0.627600000000 AA   -1.185992115777   1.185992115777  -1.185992115777 Bohr   0.0
[INPUT]  5 H5    -0.627600000000  -0.627600000000   0.627600000000 AA   -1.185992115777  -1.185992115777   1.185992115777 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] H3
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1
[INPUT] H2
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1
[INPUT] H5
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1
[INPUT] C1
[INPUT] 0    0    [8    /2   ]  8236              0.000531 -0.000113
                                1235              0.004108 -0.000878
                                280.8             0.021087 -0.00454
                                79.27             0.081853 -0.018133
                                25.59             0.234817 -0.05576
                                8.997             0.434401 -0.126895
                                3.319             0.346129 -0.170352
                                0.3643            -0.008983 0.598684
[INPUT] 0    0    [1    /1   ]  0.9059               1
[INPUT] 0    0    [1    /1   ]  0.1285               1
[INPUT] 1    0    [3    /1   ]  18.71             0.014031
                                4.133             0.086866
                                1.2               0.290216
[INPUT] 1    0    [1    /1   ]  0.3827               1
[INPUT] 1    0    [1    /1   ]  0.1209               1
[INPUT] 2    0    [1    /1   ]  1.097                1
[INPUT] 2    0    [1    /1   ]  0.318                1
[INPUT] 3    0    [1    /1   ]  0.761                1
[INPUT] H4
[INPUT] 0    0    [3    /1   ]  33.87             0.006068
                                5.095             0.045308
                                1.159             0.202822
[INPUT] 0    0    [1    /1   ]  0.3258               1
[INPUT] 0    0    [1    /1   ]  0.1027               1
[INPUT] 1    0    [1    /1   ]  1.407                1
[INPUT] 1    0    [1    /1   ]  0.388                1
[INPUT] 2    0    [1    /1   ]  1.057                1

nuclear repulsion = 13.4720345873821
number of shells = 33
number of NR pGTOs = 106
number of NR cGTOs = 86
basis = cc-pVTZ
ecp = {}
CPU time:        47.93


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /var/folders/_x/xd2ms3z958s6pfllwphw48vm0000gn/T/tmpco_298q9
max_memory 4000 MB (current use 0 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
E1 = -78.82934523356296  E_coul = 25.321983436507725
init E= -40.0353272096731
cond(S) = 3530.103678215529
    CPU time for initialize scf      2.62 sec, wall time      0.44 sec
  HOMO = -0.474483474120312  LUMO = 0.10105434510678
  mo_energy =
[-11.32569878  -1.24601418  -0.47448347  -0.47448347  -0.47448347
   0.10105435   0.19853612   0.19853612   0.19853612   0.3427568
   0.3427568    0.3427568    0.56008371   0.57640928   0.57640928
   0.57640928   0.64439593   0.64439593   0.71981621   1.04420667
   1.04420667   1.04420667   1.11515941   1.11515941   1.11515941
   1.28550503   1.28550503   1.28550503   1.49146286   1.49146286
   1.49146286   1.56025125   1.56025125   1.73467497   2.35403045
   2.35403045   2.35403045   2.49081503   2.91046993   2.91046993
   2.91046993   3.04871594   3.04871594   3.05909891   3.05909891
   3.05909891   3.22448847   3.22448847   3.22448847   3.55694166
   3.55694166   3.55694166   3.67509345   3.67509345   3.67509345
   3.73970002   3.73970002   3.82383385   4.03382285   4.03382285
   4.03382285   4.06381214   4.06381214   4.34389006   4.34389006
   4.34389006   4.48594188   4.48594188   4.48594188   4.74915353
   5.00272213   5.00272213   5.00272213   5.41044896   5.41044896
   5.41044896   5.43610838   5.43610838   5.43610838   5.49657995
   5.57434885   5.57434885   6.11851282   6.11851282   6.11851282
  14.43655517]
E1 = -79.73912067894923  E_coul = 26.06152219293839
cycle= 1 E= -40.2055638986288  delta_E= -0.17  |g|= 0.154  |ddm|= 1.08
    CPU time for cycle= 1      0.72 sec, wall time      0.09 sec
  HOMO = -0.54952032366504  LUMO = 0.139945790643714
  mo_energy =
[-11.20666755  -0.95573411  -0.54952032  -0.54952032  -0.54952032
   0.13994579   0.22619664   0.22619664   0.22619664   0.36136263
   0.36136263   0.36136263   0.63463261   0.64158296   0.64158296
   0.64158296   0.67712048   0.67712048   0.75261937   1.07032579
   1.07032579   1.07032579   1.15364971   1.15364971   1.15364971
   1.31440495   1.31440495   1.31440495   1.53102807   1.53102807
   1.53102807   1.59414539   1.59414539   1.80040652   2.41198315
   2.41198315   2.41198315   2.55589065   2.9837268    2.9837268
   2.9837268    3.12677181   3.12677181   3.13105006   3.13105006
   3.13105006   3.30172016   3.30172016   3.30172016   3.60725092
   3.60725092   3.60725092   3.73068187   3.73068187   3.73068187
   3.79115611   3.79115611   3.87330295   4.08391352   4.08391352
   4.08391352   4.11091169   4.11091169   4.37773091   4.37773091
   4.37773091   4.53079174   4.53079174   4.53079174   4.82928323
   5.05306485   5.05306485   5.05306485   5.47790651   5.47790651
   5.47790651   5.50426729   5.50426729   5.50426729   5.56449041
   5.63845873   5.63845873   6.204797     6.204797     6.204797
  14.52050801]
E1 = -79.80195465202735  E_coul = 26.1170684659949
cycle= 2 E= -40.2128515986504  delta_E= -0.00729  |g|= 0.0362  |ddm|= 0.0947
    CPU time for cycle= 2      3.72 sec, wall time      0.52 sec
  HOMO = -0.544049702587582  LUMO = 0.143602915916367
  mo_energy =
[-11.20172189  -0.94299525  -0.5440497   -0.5440497   -0.5440497
   0.14360292   0.22962661   0.22962661   0.22962661   0.36458117
   0.36458117   0.36458117   0.64291624   0.64903846   0.64903846
   0.64903846   0.68514335   0.68514335   0.75814913   1.07690398
   1.07690398   1.07690398   1.15909563   1.15909563   1.15909563
   1.32000044   1.32000044   1.32000044   1.53666106   1.53666106
   1.53666106   1.60025666   1.60025666   1.81097264   2.42373644
   2.42373644   2.42373644   2.56570181   2.9925257    2.9925257
   2.9925257    3.13746466   3.13746466   3.14205717   3.14205717
   3.14205717   3.31074185   3.31074185   3.31074185   3.61988253
   3.61988253   3.61988253   3.7420324    3.7420324    3.7420324
   3.80194206   3.80194206   3.88515442   4.09769439   4.09769439
   4.09769439   4.12494396   4.12494396   4.38992607   4.38992607
   4.38992607   4.5423122    4.5423122    4.5423122    4.84461977
   5.0648396    5.0648396    5.0648396    5.4911558    5.4911558
   5.4911558    5.51601519   5.51601519   5.51601519   5.57744709
   5.65098568   5.65098568   6.21921864   6.21921864   6.21921864
  14.52778481]
E1 = -79.79456721103301  E_coul = 26.10914063966748
cycle= 3 E= -40.2133919839834  delta_E= -0.00054  |g|= 0.00451  |ddm|= 0.0345
    CPU time for cycle= 3      3.18 sec, wall time      0.44 sec
  HOMO = -0.545729832810996  LUMO = 0.143489408650722
  mo_energy =
[-11.20757866  -0.94423654  -0.54572983  -0.54572983  -0.54572983
   0.14348941   0.22945975   0.22945975   0.22945975   0.3641206
   0.3641206    0.3641206    0.64215415   0.64806182   0.64806182
   0.64806182   0.6845305    0.6845305    0.75771967   1.07658845
   1.07658845   1.07658845   1.1581515    1.1581515    1.1581515
   1.31958997   1.31958997   1.31958997   1.53576684   1.53576684
   1.53576684   1.59964581   1.59964581   1.80993984   2.42291009
   2.42291009   2.42291009   2.56427      2.99039931   2.99039931
   2.99039931   3.13546493   3.13546493   3.14044092   3.14044092
   3.14044092   3.30849062   3.30849062   3.30849062   3.61947311
   3.61947311   3.61947311   3.74112616   3.74112616   3.74112616
   3.80120184   3.80120184   3.88458027   4.09739496   4.09739496
   4.09739496   4.12475941   4.12475941   4.39002396   4.39002396
   4.39002396   4.54190964   4.54190964   4.54190964   4.84323792
   5.0641449    5.0641449    5.0641449    5.49003641   5.49003641
   5.49003641   5.51470483   5.51470483   5.51470483   5.57620872
   5.64989922   5.64989922   6.21742916   6.21742916   6.21742916
  14.5241495 ]
E1 = -79.80377763820232  E_coul = 26.11834237444262
cycle= 4 E= -40.2134006763776  delta_E= -8.69e-06  |g|= 0.00142  |ddm|= 0.0049
    CPU time for cycle= 4      2.65 sec, wall time      0.36 sec
  HOMO = -0.545257281828334  LUMO = 0.143606426900505
  mo_energy =
[-11.20562669  -0.94358304  -0.54525728  -0.54525728  -0.54525728
   0.14360643   0.2296004    0.2296004    0.2296004    0.36424875
   0.36424875   0.36424875   0.64247027   0.64845461   0.64845461
   0.64845461   0.68486149   0.68486149   0.75787521   1.07676791
   1.07676791   1.07676791   1.15846146   1.15846146   1.15846146
   1.31978699   1.31978699   1.31978699   1.53613008   1.53613008
   1.53613008   1.59991576   1.59991576   1.81042714   2.42333368
   2.42333368   2.42333368   2.56478235   2.99112336   2.99112336
   2.99112336   3.13613586   3.13613586   3.14100328   3.14100328
   3.14100328   3.30924441   3.30924441   3.30924441   3.61981903
   3.61981903   3.61981903   3.7416053    3.7416053    3.7416053
   3.80159505   3.80159505   3.8849843    4.09775661   4.09775661
   4.09775661   4.12514012   4.12514012   4.39031182   4.39031182
   4.39031182   4.54226537   4.54226537   4.54226537   4.84391856
   5.06459654   5.06459654   5.06459654   5.49059938   5.49059938
   5.49059938   5.51523173   5.51523173   5.51523173   5.5768028
   5.65044051   5.65044051   6.21818062   6.21818062   6.21818062
  14.52538106]
E1 = -79.80015401244208  E_coul = 26.114717966392057
cycle= 5 E= -40.2134014586679  delta_E= -7.82e-07  |g|= 0.000229  |ddm|= 0.00168
    CPU time for cycle= 5      2.76 sec, wall time      0.36 sec
  HOMO = -0.545292176103615  LUMO = 0.143597353518563
  mo_energy =
[-11.20576045  -0.94363677  -0.54529218  -0.54529218  -0.54529218
   0.14359735   0.22960026   0.22960026   0.22960026   0.3642369
   0.3642369    0.3642369    0.64244657   0.64844098   0.64844098
   0.64844098   0.68485865   0.68485865   0.7578634    1.07676167
   1.07676167   1.07676167   1.15844362   1.15844362   1.15844362
   1.31977859   1.31977859   1.31977859   1.53611826   1.53611826
   1.53611826   1.59990525   1.59990525   1.81041778   2.42332852
   2.42332852   2.42332852   2.56475386   2.99108463   2.99108463
   2.99108463   3.13609828   3.13609828   3.14097719   3.14097719
   3.14097719   3.30920286   3.30920286   3.30920286   3.61982365
   3.61982365   3.61982365   3.74160116   3.74160116   3.74160116
   3.80158796   3.80158796   3.8849896    4.09776931   4.09776931
   4.09776931   4.1251605    4.1251605    4.39033463   4.39033463
   4.39033463   4.54227082   4.54227082   4.54227082   4.84391022
   5.06459972   5.06459972   5.06459972   5.49059577   5.49059577
   5.49059577   5.51521548   5.51521548   5.51521548   5.57679621
   5.65043477   5.65043477   6.21816314   6.21816314   6.21816314
  14.52530143]
E1 = -79.80025218693663  E_coul = 26.11481610916547
cycle= 6 E= -40.2134014903891  delta_E= -3.17e-08  |g|= 2.64e-05  |ddm|= 0.000623
    CPU time for cycle= 6      4.31 sec, wall time      0.59 sec
  HOMO = -0.545295397036817  LUMO = 0.143594422282059
  mo_energy =
[-11.20577238  -0.94364476  -0.5452954   -0.5452954   -0.5452954
   0.14359442   0.22959905   0.22959905   0.22959905   0.36423428
   0.36423428   0.36423428   0.64244094   0.64843806   0.64843806
   0.64843806   0.68485574   0.68485574   0.75785998   1.07675906
   1.07675906   1.07675906   1.15843951   1.15843951   1.15843951
   1.31977576   1.31977576   1.31977576   1.53611507   1.53611507
   1.53611507   1.59990206   1.59990206   1.81041257   2.42332467
   2.42332467   2.42332467   2.56474768   2.99107811   2.99107811
   2.99107811   3.13609152   3.13609152   3.14097128   3.14097128
   3.14097128   3.30919588   3.30919588   3.30919588   3.61982082
   3.61982082   3.61982082   3.74159761   3.74159761   3.74159761
   3.80158416   3.80158416   3.8849866    4.09776707   4.09776707
   4.09776707   4.12515899   4.12515899   4.39033356   4.39033356
   4.39033356   4.54226809   4.54226809   4.54226809   4.84390542
   5.0645967    5.0645967    5.0645967    5.49059189   5.49059189
   5.49059189   5.5152103    5.5152103    5.5152103    5.57679187
   5.65043072   5.65043072   6.21815772   6.21815772   6.21815772
  14.52529316]
E1 = -79.80026819428508  E_coul = 26.114832116151415
cycle= 7 E= -40.2134014907516  delta_E= -3.63e-10  |g|= 1.29e-06  |ddm|= 7.14e-05
    CPU time for cycle= 7      3.15 sec, wall time      0.44 sec
  HOMO = -0.545295165404639  LUMO = 0.143594438157887
  mo_energy =
[-11.20577166  -0.94364482  -0.54529517  -0.54529517  -0.54529517
   0.14359444   0.22959913   0.22959913   0.22959913   0.36423444
   0.36423444   0.36423444   0.64244113   0.64843831   0.64843831
   0.64843831   0.6848559    0.6848559    0.75786019   1.07675918
   1.07675918   1.07675918   1.15843975   1.15843975   1.15843975
   1.3197759    1.3197759    1.3197759    1.53611527   1.53611527
   1.53611527   1.59990223   1.59990223   1.81041287   2.42332495
   2.42332495   2.42332495   2.564748     2.99107853   2.99107853
   2.99107853   3.13609195   3.13609195   3.14097165   3.14097165
   3.14097165   3.30919632   3.30919632   3.30919632   3.61982104
   3.61982104   3.61982104   3.74159786   3.74159786   3.74159786
   3.80158441   3.80158441   3.88498682   4.09776727   4.09776727
   4.09776727   4.12515917   4.12515917   4.39033369   4.39033369
   4.39033369   4.5422683    4.5422683    4.5422683    4.84390577
   5.06459693   5.06459693   5.06459693   5.4905922    5.4905922
   5.4905922    5.51521063   5.51521063   5.51521063   5.57679219
   5.65043103   5.65043103   6.21815813   6.21815813   6.21815813
  14.52529365]
E1 = -79.80026683035474  E_coul = 26.11483075222095
Extra cycle  E= -40.2134014907517  delta_E= -1.28e-13  |g|= 3.36e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle     25.79 sec, wall time      3.62 sec
    CPU time for SCF     25.85 sec, wall time      3.62 sec
converged SCF energy = -40.2134014907517
